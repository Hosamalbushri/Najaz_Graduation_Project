# دليل اختبار نظام Word → PDF

## قبل البدء

تأكد من:
1. ✅ تم تشغيل `composer install`
2. ✅ تم تشغيل `php artisan migrate`
3. ✅ الـ storage له صلاحيات الكتابة: `chmod -R 775 storage`

## سيناريوهات الاختبار

### السيناريو 1: خدمة بدون حقول ملفات

**الهدف:** التأكد أن النظام لا يعرض خيارات Word للخدمات التي لا تحتوي على حقول ملفات

**الخطوات:**
1. أنشئ خدمة جديدة بحقول نصية فقط (text, number, date, etc.)
2. قدم طلب لهذه الخدمة
3. انتقل إلى معالجة الطلب
4. غير الحالة إلى "قيد المعالجة"

**النتيجة المتوقعة:**
- ✅ لا يظهر زر "تحميل ملف Word"
- ✅ لا يظهر تبويب "معالجة الوثيقة"
- ✅ يعمل النظام بالطريقة التقليدية

---

### السيناريو 2: خدمة مع حقول ملفات (التدفق الكامل)

**الهدف:** اختبار التدفق الكامل من توليد Word إلى رفع PDF

#### الجزء 1: إعداد الخدمة

1. **إنشاء خدمة:**
   - الاسم: "طلب استخراج رخصة قيادة"
   - أضف مجموعة سمات مع الحقول:
     * `full_name` (text)
     * `national_id_image` (image)
     * `medical_report` (file)
   
2. **إنشاء قالب:**
   - انتقل إلى "قوالب الخدمات"
   - أنشئ قالب للخدمة
   - أضف محتوى مثل:
     ```html
     <h1>رخصة القيادة</h1>
     <p>الاسم: {{full_name}}</p>
     <p>رقم الهوية: [من الصورة]</p>
     <p>نتيجة الفحص الطبي: [من الملف]</p>
     ```

#### الجزء 2: تقديم الطلب

3. **تقديم الطلب (كمواطن):**
   - سجل دخول كمواطن
   - اذهب إلى الخدمات
   - اختر "طلب استخراج رخصة قيادة"
   - املأ النموذج:
     * الاسم: "أحمد محمد"
     * صورة الهوية: ارفع صورة
     * التقرير الطبي: ارفع PDF
   - قدم الطلب

**النتيجة المتوقعة:**
- ✅ الطلب مقدم بنجاح
- ✅ الحالة: "قيد الانتظار"
- ✅ الملفات محفوظة

#### الجزء 3: معالجة الطلب

4. **تغيير الحالة:**
   - سجل دخول كموظف
   - اذهب إلى "طلبات الخدمات"
   - افتح الطلب
   - اضغط زر "قيد المعالجة"

**النتيجة المتوقعة:**
- ✅ الحالة تغيرت إلى "قيد المعالجة"
- ✅ يظهر زر "تحميل ملف Word القابل للتعبئة"

5. **تحميل Word:**
   - اضغط زر "تحميل ملف Word"

**النتيجة المتوقعة:**
- ✅ يتم تحميل ملف `.docx`
- ✅ اسم الملف: `editable-SR001.docx` (أو رقم الطلب)
- ✅ الملف يفتح في Word
- ✅ الاسم "أحمد محمد" موجود في الملف
- ✅ مكان رقم الهوية يحتوي: `[أدخل البيانات من الملف: national_id_image]`
- ✅ مكان نتيجة الفحص: `[أدخل البيانات من الملف: medical_report]`

6. **تعبئة الملف:**
   - افتح الملف المحمل
   - افتح صورة الهوية في تبويب آخر في المتصفح
   - استخرج رقم الهوية من الصورة: مثلاً "1234567890"
   - افتح التقرير الطبي
   - استخرج نتيجة الفحص: مثلاً "لائق صحياً"
   - املأ الحقول في ملف Word
   - احفظ الملف كـ PDF: File → Save As → PDF
   - سمّه: `filled-SR001.pdf`

7. **رفع PDF:**
   - ارجع إلى صفحة الطلب في النظام
   - افتح تبويب "معالجة الوثيقة"
   - في قسم "رفع ملف PDF":
     * اختر الملف `filled-SR001.pdf`
     * اضغط "رفع"

**النتيجة المتوقعة:**
- ✅ رسالة نجاح: "تم رفع ملف PDF بنجاح"
- ✅ الصفحة تتحدث تلقائياً
- ✅ في قسم "حالة الوثيقة":
  * الحالة: "جاهز للطباعة"
  * تم التعبئة بواسطة: اسم الموظف
  * تاريخ التعبئة: التاريخ والوقت الحالي

8. **إكمال الطلب:**
   - اضغط زر "إكمال"

**النتيجة المتوقعة:**
- ✅ الحالة تغيرت إلى "مكتمل"
- ✅ يظهر زر "طباعة"

#### الجزء 4: الطباعة

9. **طباعة الوثيقة:**
   - اضغط زر "طباعة"

**النتيجة المتوقعة:**
- ✅ يتم تحميل ملف PDF
- ✅ الملف المحمل هو نفس الملف المرفوع (filled-SR001.pdf)
- ✅ يحتوي على:
  * الاسم: "أحمد محمد"
  * رقم الهوية: "1234567890"
  * نتيجة الفحص: "لائق صحياً"

---

### السيناريو 3: اختبار التحقق (Validation)

**الهدف:** التأكد من التحقق الصحيح للملفات المرفوعة

#### 3.1: رفع ملف ليس PDF

**الخطوات:**
1. اتبع السيناريو 2 حتى خطوة رفع PDF
2. حاول رفع ملف Word بدلاً من PDF

**النتيجة المتوقعة:**
- ✅ رسالة خطأ: validation error
- ✅ الملف لم يُرفع

#### 3.2: رفع ملف PDF كبير

**الخطوات:**
1. أنشئ ملف PDF بحجم أكبر من 10 ميجابايت
2. حاول رفعه

**النتيجة المتوقعة:**
- ✅ رسالة خطأ: "الملف كبير جداً"
- ✅ الملف لم يُرفع

#### 3.3: رفع PDF بدون اختيار ملف

**الخطوات:**
1. اضغط زر "رفع" بدون اختيار ملف

**النتيجة المتوقعة:**
- ✅ تحذير من المتصفح: "Please select a file"

---

### السيناريو 4: إعادة الرفع

**الهدف:** التأكد من إمكانية استبدال PDF المرفوع

**الخطوات:**
1. اتبع السيناريو 2 حتى رفع PDF الأول
2. عدّل الملف وارفعه مرة أخرى

**النتيجة المتوقعة:**
- ✅ الملف القديم يُحذف
- ✅ الملف الجديد يُحفظ
- ✅ تاريخ التعبئة يتحدث
- ✅ عند الطباعة، يُحمل الملف الجديد

---

### السيناريو 5: اختبار الصلاحيات

**الهدف:** التأكد من حماية الوصول

#### 5.1: موظف بدون صلاحيات

**الخطوات:**
1. أنشئ موظف بدون صلاحية `service-requests.view`
2. حاول الوصول إلى طلب خدمة

**النتيجة المتوقعة:**
- ✅ رسالة "غير مصرح"

#### 5.2: وصول مباشر للرابط

**الخطوات:**
1. سجل خروج
2. حاول الوصول إلى:
   ```
   /admin/service-requests/download-word/1
   ```

**النتيجة المتوقعة:**
- ✅ إعادة توجيه إلى صفحة تسجيل الدخول

---

### السيناريو 6: اختبار الأداء

**الهدف:** التأكد من أداء النظام مع ملفات كبيرة

**الخطوات:**
1. أنشئ قالب كبير (عدة صفحات)
2. أضف عدة حقول ملفات/صور
3. قدم طلب مع ملفات كبيرة
4. جرب توليد Word

**النتيجة المتوقعة:**
- ✅ التوليد ينجح (قد يأخذ وقت أطول)
- ✅ لا توجد أخطاء timeout
- ✅ الملف يحتوي على كل المحتوى

---

### السيناريو 7: اختبار التوافقية

**الهدف:** التأكد من التوافق مع أنظمة مختلفة

#### 7.1: فتح Word في Microsoft Word

**الخطوات:**
1. حمل ملف Word
2. افتحه في Microsoft Word 2016+ / Office 365

**النتيجة المتوقعة:**
- ✅ الملف يفتح بدون أخطاء
- ✅ التنسيق صحيح
- ✅ يمكن التعديل
- ✅ يمكن الحفظ كـ PDF

#### 7.2: فتح Word في LibreOffice

**الخطوات:**
1. حمل ملف Word
2. افتحه في LibreOffice Writer

**النتيجة المتوقعة:**
- ✅ الملف يفتح (قد يكون هناك اختلافات طفيفة في التنسيق)
- ✅ يمكن التعديل
- ✅ يمكن التصدير إلى PDF

#### 7.3: فتح Word في Google Docs

**الخطوات:**
1. حمل ملف Word
2. ارفعه إلى Google Drive
3. افتحه في Google Docs

**النتيجة المتوقعة:**
- ✅ الملف يفتح
- ✅ يمكن التعديل
- ✅ يمكن التنزيل كـ PDF

---

## الأخطاء الشائعة وكيفية إصلاحها

### 1. "Template not found"

**التشخيص:**
```bash
php artisan tinker
>>> $service = \Najaz\Service\Models\Service::find(1);
>>> $service->documentTemplate;
```

**الحل:**
- أنشئ قالب للخدمة
- أو فعّل القالب: `UPDATE service_document_templates SET is_active = 1 WHERE service_id = 1;`

### 2. "Failed to generate Word"

**التشخيص:**
```bash
tail -f storage/logs/laravel.log
```

**الحلول المحتملة:**
- تأكد من وجود PHPWord: `composer show phpoffice/phpword`
- تحقق من صلاحيات storage: `chmod -R 775 storage`
- تحقق من مساحة القرص: `df -h`

### 3. "Upload failed"

**التشخيص:**
```bash
# تحقق من إعدادات PHP
php -i | grep upload_max_filesize
php -i | grep post_max_size
```

**الحل:**
عدّل `php.ini`:
```ini
upload_max_filesize = 10M
post_max_size = 10M
```

---

## Checklist النهائي

قبل النشر للإنتاج، تأكد من:

- [ ] جميع migrations تعمل
- [ ] PHPWord مثبت
- [ ] Storage له صلاحيات الكتابة
- [ ] PHP settings محدثة (upload_max_filesize, etc.)
- [ ] جميع الترجمات موجودة
- [ ] الصلاحيات مضبوطة
- [ ] اختبار التدفق الكامل يعمل
- [ ] اختبار Validation يعمل
- [ ] لا توجد أخطاء في الـ logs
- [ ] الأداء مقبول مع ملفات كبيرة
- [ ] التوثيق محدث

---

## أدوات مساعدة للاختبار

### 1. إنشاء بيانات تجريبية

```php
// في tinker
$service = \Najaz\Service\Models\Service::create([...]);
$request = \Najaz\Request\Models\ServiceRequest::create([...]);
```

### 2. فحص الملفات المحفوظة

```bash
ls -lah storage/app/service_requests/*/
```

### 3. مراقبة الـ Logs مباشرة

```bash
tail -f storage/logs/laravel.log | grep -i "word\|pdf"
```

### 4. اختبار API مباشرة

```bash
# تحميل Word
curl -X GET http://localhost/admin/service-requests/download-word/1 \
  -H "Cookie: laravel_session=..." \
  --output test.docx

# رفع PDF
curl -X POST http://localhost/admin/service-requests/upload-pdf/1 \
  -H "Cookie: laravel_session=..." \
  -F "filled_pdf=@test.pdf"
```

---

## نتائج الاختبار المتوقعة

بعد إكمال جميع السيناريوهات:

✅ **التدفق الأساسي:**
- توليد Word يعمل
- رفع PDF يعمل
- الطباعة تستخدم PDF المرفوع

✅ **التحقق:**
- رفض ملفات غير PDF
- رفض ملفات كبيرة
- حماية الوصول

✅ **الأداء:**
- الاستجابة سريعة (< 5 ثواني لتوليد Word)
- لا توجد أخطاء memory

✅ **التوافقية:**
- Word يفتح في برامج مختلفة
- PDF يُنشأ بنجاح
- جميع المتصفحات تعمل

---

## الخلاصة

هذا الدليل يغطي جميع سيناريوهات الاختبار الأساسية. لأي مشاكل:

1. راجع الـ logs
2. تحقق من الصلاحيات
3. تأكد من المتطلبات
4. راجع التوثيق الكامل في `docs/word-pdf-document-system.md`

